import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from 'firebase/firestore';

// Firebase configuration (provided by the environment)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cpt-app';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase App
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Main App Component
function App() {
  const [currentScreen, setCurrentScreen] = useState('start'); // 'start', 'playing', 'results', 'settings'
  const [userId, setUserId] = useState(null);
  const [highScore, setHighScore] = useState(0);
  const [lastGameScore, setLastGameScore] = useState(0);
  const [charDisplayDuration, setCharDisplayDuration] = useState(500); // milliseconds
  const [intervalBetweenChars, setIntervalBetweenChars] = useState(1500); // milliseconds
  const [isAuthReady, setIsAuthReady] = useState(false);

  // Firebase Authentication and Firestore Listener for High Score
  useEffect(() => {
    const signIn = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Firebase authentication error:", error);
      }
    };

    signIn();

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
        setIsAuthReady(true);
      } else {
        setUserId(null);
        setIsAuthReady(true); // Still ready, but no user logged in
      }
    });

    return () => unsubscribe();
  }, []); // Run only once on component mount

  // Firestore listener for high score
  useEffect(() => {
    if (!isAuthReady || !userId) return;

    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/cpt_scores/high_score`);

    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
      if (docSnap.exists()) {
        setHighScore(docSnap.data().value || 0);
      } else {
        setHighScore(0); // No high score yet
      }
    }, (error) => {
      console.error("Error fetching high score:", error);
    });

    return () => unsubscribe();
  }, [isAuthReady, userId]); // Re-run if auth state or userId changes

  // Function to update high score in Firestore
  const updateHighScore = useCallback(async (newScore) => {
    if (!userId || newScore <= highScore) return; // Only update if it's a new high score

    try {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/cpt_scores/high_score`);
      await setDoc(userDocRef, { value: newScore }, { merge: true });
      console.log("High score updated successfully!");
    } catch (error) {
      console.error("Error updating high score:", error);
    }
  }, [userId, highScore]);

  // Render different screens based on currentScreen state
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4 font-inter text-white">
      <div className="bg-white bg-opacity-20 backdrop-filter backdrop-blur-lg rounded-3xl shadow-2xl p-8 w-full max-w-md text-center border border-white border-opacity-30">
        <h1 className="text-4xl font-extrabold mb-6 text-white drop-shadow-lg">Ø£Ø¯Ø§Ø© ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ Ø§Ù„Ù…Ø³ØªÙ…Ø±</h1>
        <h2 className="text-2xl font-semibold mb-8 text-white drop-shadow-md">(CPT)</h2>

        {currentScreen === 'start' && (
          <StartScreen
            userId={userId}
            highScore={highScore}
            onStart={() => setCurrentScreen('playing')}
            onSettings={() => setCurrentScreen('settings')}
            isAuthReady={isAuthReady}
          />
        )}

        {currentScreen === 'playing' && (
          <GameScreen
            charDisplayDuration={charDisplayDuration}
            intervalBetweenChars={intervalBetweenChars}
            onGameEnd={(score) => {
              setLastGameScore(score);
              updateHighScore(score); // Attempt to update high score
              setCurrentScreen('results');
            }}
          />
        )}

        {currentScreen === 'results' && (
          <ResultsScreen
            score={lastGameScore}
            highScore={highScore}
            onPlayAgain={() => setCurrentScreen('playing')}
            onBackToHome={() => setCurrentScreen('start')}
          />
        )}

        {currentScreen === 'settings' && (
          <SettingsScreen
            charDisplayDuration={charDisplayDuration}
            setCharDisplayDuration={setCharDisplayDuration}
            intervalBetweenChars={intervalBetweenChars}
            setIntervalBetweenChars={setIntervalBetweenChars}
            onBack={() => setCurrentScreen('start')}
          />
        )}
      </div>
    </div>
  );
}

// Start Screen Component
function StartScreen({ userId, highScore, onStart, onSettings, isAuthReady }) {
  return (
    <div className="flex flex-col items-center">
      <p className="text-lg mb-4 text-white">
        Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {isAuthReady ? (userId || 'ØºÙŠØ± Ù…ØªØ§Ø­') : 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...'}
      </p>
      <p className="text-xl font-bold mb-8 text-white">
        Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù…Ø³Ø¬Ù„Ø©: <span className="text-yellow-300">{highScore}</span>
      </p>
      <button
        onClick={onStart}
        className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 mb-4 text-2xl"
      >
        Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
      </button>
      <button
        onClick={onSettings}
        className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 text-xl"
      >
        Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠ
      </button>
    </div>
  );
}

// Game Screen Component
function GameScreen({ charDisplayDuration, intervalBetweenChars, onGameEnd }) {
  const [currentChar, setCurrentChar] = useState('');
  const [isX, setIsX] = useState(false);
  const [score, setScore] = useState(0);
  const [correctHits, setCorrectHits] = useState(0);
  const [missedXs, setMissedXs] = useState(0);
  const [incorrectHits, setIncorrectHits] = useState(0);
  const [gameActive, setGameActive] = useState(false);
  const [message, setMessage] = useState('Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
  const [roundCount, setRoundCount] = useState(0);
  const totalRounds = 20; // Fixed number of rounds for the game

  const timeoutRef = useRef(null);
  const spacebarPressedRef = useRef(false);
  const currentIsXRef = useRef(false);

  // Function to start a new round
  const startRound = useCallback(() => {
    if (roundCount >= totalRounds) {
      endGame();
      return;
    }

    setRoundCount(prev => prev + 1);
    spacebarPressedRef.current = false; // Reset spacebar flag for new round

    // Decide if the character is 'X' (20% chance) or another random character
    const charType = Math.random() < 0.2 ? 'X' : String.fromCharCode(65 + Math.floor(Math.random() * 25)); // A-Z
    setCurrentChar(charType);
    const isCurrentCharX = charType === 'X';
    setIsX(isCurrentCharX);
    currentIsXRef.current = isCurrentCharX; // Update ref for event listener

    setMessage(''); // Clear any previous messages

    // Set timeout for character display
    timeoutRef.current = setTimeout(() => {
      // If 'X' was displayed and spacebar was NOT pressed, it's a missed X
      if (currentIsXRef.current && !spacebarPressedRef.current) {
        setMissedXs(prev => prev + 1);
        setScore(prev => Math.max(0, prev - 10)); // Penalize for missed X
      }
      setCurrentChar(''); // Hide character
      // Set timeout for interval before next character
      timeoutRef.current = setTimeout(startRound, intervalBetweenChars);
    }, charDisplayDuration);
  }, [roundCount, charDisplayDuration, intervalBetweenChars]);

  // Function to handle spacebar press
  const handleSpacebarPress = useCallback((event) => {
    if (!gameActive) return;

    if (event.code === 'Space') {
      event.preventDefault(); // Prevent scrolling
      if (spacebarPressedRef.current) return; // Already pressed for this round

      spacebarPressedRef.current = true;

      if (currentIsXRef.current) {
        setCorrectHits(prev => prev + 1);
        setScore(prev => prev + 10); // Reward for correct hit
        setMessage('ØµØ­ÙŠØ­!');
      } else {
        setIncorrectHits(prev => prev + 1);
        setScore(prev => Math.max(0, prev - 5)); // Penalize for incorrect hit
        setMessage('Ø®Ø·Ø£!');
      }
    }
  }, [gameActive]);

  // Function to start the game
  const startGame = () => {
    setScore(0);
    setCorrectHits(0);
    setMissedXs(0);
    setIncorrectHits(0);
    setRoundCount(0);
    setGameActive(true);
    setMessage('Ø§Ø³ØªØ¹Ø¯...');
    // Initial delay before the first character appears
    timeoutRef.current = setTimeout(startRound, 2000);
  };

  // Function to end the game
  const endGame = useCallback(() => {
    setGameActive(false);
    clearTimeout(timeoutRef.current);
    setCurrentChar('');
    setMessage('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!');
    onGameEnd(score); // Pass the final score to parent component
  }, [score, onGameEnd]);

  // Effect for keyboard event listener
  useEffect(() => {
    window.addEventListener('keydown', handleSpacebarPress);
    return () => {
      window.removeEventListener('keydown', handleSpacebarPress);
      clearTimeout(timeoutRef.current); // Clean up timeout on unmount
    };
  }, [handleSpacebarPress]);

  return (
    <div className="flex flex-col items-center justify-center">
      <p className="text-lg mb-4 text-white">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„Ù…Ø³Ø§ÙØ©" (Spacebar) ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø­Ø±Ù <span className="font-bold text-yellow-300">'X'</span>
      </p>
      <p className="text-lg mb-6 text-white">
        ØªØ¬Ø§Ù‡Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø£Ø®Ø±Ù‰.
      </p>

      <div className="relative w-48 h-48 flex items-center justify-center bg-white bg-opacity-30 rounded-2xl mb-8 shadow-inner">
        {currentChar && (
          <span className={`text-8xl font-extrabold ${isX ? 'text-green-300' : 'text-red-300'} animate-fade-in-out`}>
            {currentChar}
          </span>
        )}
      </div>

      <p className="text-2xl font-bold mb-4 text-white">{message}</p>
      <p className="text-xl font-semibold mb-6 text-white">Ø§Ù„Ù†ØªÙŠØ¬Ø©: {score}</p>

      {!gameActive && (
        <button
          onClick={startGame}
          className="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 text-xl"
        >
          Ø§Ø¨Ø¯Ø£
        </button>
      )}

      {gameActive && (
        <div className="text-white text-lg mt-4">
          <p>Ø§Ù„Ø¬ÙˆÙ„Ø©: {roundCount} Ù…Ù† {totalRounds}</p>
          <p>Ø¶Ø±Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©: {correctHits}</p>
          <p>Ø¶Ø±Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©: {incorrectHits}</p>
          <p>X Ù…ÙÙ‚ÙˆØ¯Ø©: {missedXs}</p>
        </div>
      )}
    </div>
  );
}

// Results Screen Component
function ResultsScreen({ score, highScore, onPlayAgain, onBackToHome }) {
  const isNewHighScore = score > (highScore || 0); // Check if current score is greater than previous high score

  return (
    <div className="flex flex-col items-center">
      <h3 className="text-3xl font-bold mb-4 text-white">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
      <p className="text-2xl mb-4 text-white">
        Ù†ØªÙŠØ¬Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©: <span className="font-extrabold text-yellow-300">{score}</span>
      </p>
      {isNewHighScore && (
        <p className="text-2xl font-bold text-green-300 mb-6 animate-bounce">
          ğŸ‰ Ø±Ù‚Ù… Ù‚ÙŠØ§Ø³ÙŠ Ø¬Ø¯ÙŠØ¯! ğŸ‰
        </p>
      )}
      <p className="text-xl mb-8 text-white">
        Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù…Ø³Ø¬Ù„Ø©: <span className="font-bold text-yellow-300">{highScore}</span>
      </p>

      <button
        onClick={onPlayAgain}
        className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 mb-4 text-xl"
      >
        Ø§Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
      </button>
      <button
        onClick={onBackToHome}
        className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 text-xl"
      >
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </button>
    </div>
  );
}

// Settings Screen Component
function SettingsScreen({
  charDisplayDuration,
  setCharDisplayDuration,
  intervalBetweenChars,
  setIntervalBetweenChars,
  onBack,
}) {
  return (
    <div className="flex flex-col items-center w-full">
      <h3 className="text-2xl font-bold mb-6 text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠ</h3>

      <div className="w-full mb-6">
        <label htmlFor="displayDuration" className="block text-lg font-semibold mb-2 text-white">
          Ù…Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±Ù (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©): <span className="text-yellow-300">{charDisplayDuration}</span>
        </label>
        <input
          type="range"
          id="displayDuration"
          min="100"
          max="1000"
          step="50"
          value={charDisplayDuration}
          onChange={(e) => setCharDisplayDuration(Number(e.target.value))}
          className="w-full h-2 bg-blue-300 rounded-lg appearance-none cursor-pointer accent-blue-600"
        />
      </div>

      <div className="w-full mb-8">
        <label htmlFor="interval" className="block text-lg font-semibold mb-2 text-white">
          Ø§Ù„ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ø±ÙˆÙ (Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©): <span className="text-yellow-300">{intervalBetweenChars}</span>
        </label>
        <input
          type="range"
          id="interval"
          min="500"
          max="3000"
          step="100"
          value={intervalBetweenChars}
          onChange={(e) => setIntervalBetweenChars(Number(e.target.value))}
          className="w-full h-2 bg-blue-300 rounded-lg appearance-none cursor-pointer accent-blue-600"
        />
      </div>

      <button
        onClick={onBack}
        className="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-200 hover:scale-105 text-xl"
      >
        Ø§Ù„Ø¹ÙˆØ¯Ø©
      </button>
    </div>
  );
}

export default App;

